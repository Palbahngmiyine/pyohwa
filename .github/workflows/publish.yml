name: Publish to crates.io

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Copy pre-built assets into pyohwa-core
        run: |
          mkdir -p crates/pyohwa-core/pre-built
          cp elm/dist/elm.min.js crates/pyohwa-core/pre-built/elm.min.js
          cp themes/default/dist/theme.css crates/pyohwa-core/pre-built/theme.css

      - name: Verify all crates can be packaged
        run: |
          cargo package -p pyohwa-search --allow-dirty
          cargo package -p pyohwa-core --allow-dirty
          echo "Packaging verified successfully"

      - name: Publish pyohwa-search
        run: |
          if cargo publish -p pyohwa-search --allow-dirty 2>&1 | tee /dev/stderr | grep -q "already exists"; then
            echo "pyohwa-search already published, skipping"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for pyohwa-search availability
        run: |
          for i in $(seq 1 12); do
            if cargo search pyohwa-search 2>/dev/null | grep -q "pyohwa-search"; then
              echo "pyohwa-search is available on crates.io"
              break
            fi
            echo "Waiting for crates.io index update... ($i/12)"
            sleep 10
          done

      - name: Publish pyohwa-core
        run: |
          if cargo publish -p pyohwa-core --allow-dirty 2>&1 | tee /dev/stderr | grep -q "already exists"; then
            echo "pyohwa-core already published, skipping"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for pyohwa-core availability
        run: |
          for i in $(seq 1 12); do
            if cargo search pyohwa-core 2>/dev/null | grep -q "pyohwa-core"; then
              echo "pyohwa-core is available on crates.io"
              break
            fi
            echo "Waiting for crates.io index update... ($i/12)"
            sleep 10
          done

      - name: Publish pyohwa-server
        run: |
          if cargo publish -p pyohwa-server --allow-dirty 2>&1 | tee /dev/stderr | grep -q "already exists"; then
            echo "pyohwa-server already published, skipping"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for pyohwa-server availability
        run: |
          for i in $(seq 1 12); do
            if cargo search pyohwa-server 2>/dev/null | grep -q "pyohwa-server"; then
              echo "pyohwa-server is available on crates.io"
              break
            fi
            echo "Waiting for crates.io index update... ($i/12)"
            sleep 10
          done

      - name: Publish pyohwa-cli
        run: |
          if cargo publish -p pyohwa-cli --allow-dirty 2>&1 | tee /dev/stderr | grep -q "already exists"; then
            echo "pyohwa-cli already published, skipping"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
